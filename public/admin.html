<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LearnHub - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        a:focus, button:focus, input:focus, select:focus {
            outline: 2px solid #4A90E2;
            outline-offset: 2px;
        }
        .sidebar-button.active {
            background-color: #4A90E2;
            color: white;
        }
        .mobile-nav-button.active {
            color: #4A90E2;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
        }
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            max-height: 80vh;
            overflow-y: auto;
        }
        .sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        .sidebar.active {
            transform: translateX(0);
        }
        @media (min-width: 640px) {
            .sidebar {
                transform: translateX(0);
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center">
                <button id="sidebar-toggle" class="sm:hidden mr-4 text-gray-600 hover:text-blue-600" aria-label="Toggle sidebar">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <a href="index.html" class="text-2xl font-bold text-blue-600 flex items-center" aria-label="LearnHub Home">
                    <i class="fas fa-graduation-cap mr-2"></i>
                    LearnHub
                </a>
            </div>
            <div class="flex items-center space-x-4">
                <button id="logout-button" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition" aria-label="Log out">Log Out</button>
            </div>
        </div>
    </header>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed top-16 left-0 h-full w-64 bg-white shadow-md z-40 sm:top-0 sm:w-56 sidebar">
        <div class="p-4">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 sm:mt-16">Admin Menu</h2>
            <nav>
                <button class="sidebar-button flex items-center w-full px-4 py-3 text-gray-600 hover:bg-blue-100 rounded-md mb-2" data-tab="dashboard">
                    <i class="fas fa-gauge mr-2"></i>
                    Dashboard
                </button>
                <button class="sidebar-button flex items-center w-full px-4 py-3 text-gray-600 hover:bg-blue-100 rounded-md mb-2" data-tab="courses">
                    <i class="fas fa-book mr-2"></i>
                    Courses
                </button>
                <button class="sidebar-button flex items-center w-full px-4 py-3 text-gray-600 hover:bg-blue-100 rounded-md mb-2" data-tab="categories">
                    <i class="fas fa-folder mr-2"></i>
                    Categories
                </button>
                <button class="sidebar-button flex items-center w-full px-4 py-3 text-gray-600 hover:bg-blue-100 rounded-md mb-2" data-tab="messages">
                    <i class="fas fa-envelope mr-2"></i>
                    Messages
                </button>
            </nav>
        </div>
    </aside>

    <!-- Login Section -->
    <section id="login-section" class="py-16 bg-white">
        <div class="container mx-auto px-4 max-w-md">
            <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">Admin Login</h2>
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="mb-4">
                    <label for="password" class="block text-gray-700 font-medium mb-2">Password</label>
                    <input type="password" id="password" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600" aria-label="Enter admin password">
                </div>
                <button id="login-button" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition" aria-label="Log in to admin dashboard">Log In</button>
            </div>
        </div>
    </section>

    <!-- Admin Dashboard -->
    <section id="dashboard-section" class="py-16 bg-white hidden sm:pl-56">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-gray-800 mb-8">Admin Dashboard</h2>
            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content">
                <h3 class="text-2xl font-semibold text-gray-800 mb-6">Dashboard Overview</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                        <div class="text-blue-600 mr-4">
                            <i class="fas fa-users text-3xl"></i>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800">Total Visitors</h4>
                            <p id="total-visitors" class="text-2xl font-bold text-gray-700">0</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                        <div class="text-blue-600 mr-4">
                            <i class="fas fa-book text-3xl"></i>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800">Total Courses</h4>
                            <p id="total-courses" class="text-2xl font-bold text-gray-700">0</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                        <div class="text-blue-600 mr-4">
                            <i class="fas fa-folder text-3xl"></i>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800">Total Categories</h4>
                            <p id="total-categories" class="text-2xl font-bold text-gray-700">0</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                        <div class="text-blue-600 mr-4">
                            <i class="fas fa-envelope text-3xl"></i>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800">New Messages Today</h4>
                            <p id="new-messages" class="text-2xl font-bold text-gray-700">0</p>
                        </div>
                    </div>
                </div>
                <!-- Latest Updates -->
                <h3 class="text-2xl font-semibold text-gray-800 mb-6">Latest Updates</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div id="latest-course" class="bg-white p-6 rounded-xl shadow-md">
                        <h4 class="text-lg font-semibold text-gray-800 mb-2">Latest Course</h4>
                        <p class="text-gray-700">No courses available.</p>
                    </div>
                    <div id="latest-category" class="bg-white p-6 rounded-xl shadow-md">
                        <h4 class="text-lg font-semibold text-gray-800 mb-2">Latest Category</h4>
                        <p class="text-gray-700">No categories available.</p>
                    </div>
                    <div id="latest-message" class="bg-white p-6 rounded-xl shadow-md">
                        <h4 class="text-lg font-semibold text-gray-800 mb-2">Latest Message</h4>
                        <p class="text-gray-700">No messages available.</p>
                    </div>
                </div>
                <!-- Analytics Section -->
                <h3 class="text-2xl font-semibold text-gray-800 mb-6">Analytics</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h4 class="text-lg font-semibold text-gray-800 mb-2">Courses by Category</h4>
                        <div id="courses-by-category" class="text-gray-700">
                            <p>Technology: <span id="tech-courses">0</span></p>
                            <p>Business: <span id="business-courses">0</span></p>
                            <p>Creative: <span id="creative-courses">0</span></p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h4 class="text-lg font-semibold text-gray-800 mb-2">Top-Rated Courses</h4>
                        <div id="top-rated-courses" class="text-gray-700">
                            <p>No courses available.</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h4 class="text-lg font-semibold text-gray-800 mb-2">Messages per Day (Last 7 Days)</h4>
                        <canvas id="messages-chart" class="w-full h-48"></canvas>
                    </div>
                </div>
            </div>

            <!-- Courses Tab -->
            <div id="courses-tab" class="tab-content">
                <h3 class="text-2xl font-semibold text-gray-800 mb-6">Manage Courses</h3>
                <!-- Latest Course Update -->
                <div id="latest-course-update" class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">Latest Course Update</h4>
                    <p class="text-gray-700">No courses available.</p>
                </div>
                <!-- Courses Table -->
                <div class="overflow-x-auto mb-8">
                    <table class="w-full bg-white rounded-xl shadow-md">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="p-4 text-left text-gray-700">Title</th>
                                <th class="p-4 text-left text-gray-700">Category</th>
                                <th class="p-4 text-left text-gray-700">Level</th>
                                <th class="p-4 text-left text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="course-table"></tbody>
                    </table>
                </div>
            </div>

            <!-- Categories Tab -->
            <div id="categories-tab" class="tab-content">
                <h3 class="text-2xl font-semibold text-gray-800 mb-6">Manage Categories</h3>
                <!-- Latest Category Update -->
                <div id="latest-category-update" class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">Latest Category Update</h4>
                    <p class="text-gray-700">No categories available.</p>
                </div>
                <!-- Categories Table -->
                <div class="overflow-x-auto mb-8">
                    <table class="w-full bg-white rounded-xl shadow-md">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="p-4 text-left text-gray-700">Title</th>
                                <th class="p-4 text-left text-gray-700">Group</th>
                                <th class="p-4 text-left text-gray-700">Course Count</th>
                                <th class="p-4 text-left text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="category-table"></tbody>
                    </table>
                </div>
            </div>

            <!-- Messages Tab -->
            <div id="messages-tab" class="tab-content">
                <h3 class="text-2xl font-semibold text-gray-800 mb-6">Manage Contact Messages</h3>
                <!-- Latest Message Update -->
                <div id="latest-message-update" class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">Latest Message</h4>
                    <p class="text-gray-700">No messages available.</p>
                </div>
                <!-- Messages Table -->
                <div class="overflow-x-auto">
                    <table class="w-full bg-white rounded-xl shadow-md">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="p-4 text-left text-gray-700">Name</th>
                                <th class="p-4 text-left text-gray-700">Email</th>
                                <th class="p-4 text-left text-gray-700">Subject</th>
                                <th class="p-4 text-left text-gray-700">Message</th>
                                <th class="p-4 text-left text-gray-700">Date</th>
                            </tr>
                        </thead>
                        <tbody id="message-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <!-- Add Course Modal -->
    <div id="course-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-xl shadow-md max-w-md w-full">
            <h4 id="course-form-title" class="text-lg font-semibold text-gray-800 mb-4">Add New Course</h4>
            <form id="course-form">
                <input type="hidden" id="course-id">
                <div class="mb-4">
                    <label for="course-title" class="block text-gray-700 font-medium mb-2">Title</label>
                    <input type="text" id="course-title" class="w-full p-2 border border-gray-300 rounded-md" required aria-label="Course title">
                </div>
                <div class="mb-4">
                    <label for="course-description" class="block text-gray-700 font-medium mb-2">Description</label>
                    <textarea id="course-description" class="w-full p-2 border border-gray-300 rounded-md" required aria-label="Course description"></textarea>
                </div>
                <div class="mb-4">
                    <label for="course-category" class="block text-gray-700 font-medium mb-2">Category</label>
                    <select id="course-category" class="w-full p-2 border border-gray-300 rounded-md" required aria-label="Course category"></select>
                </div>
                <div class="mb-4">
                    <label for="course-level" class="block text-gray-700 font-medium mb-2">Level</label>
                    <select id="course-level" class="w-full p-2 border border-gray-300 rounded-md" required aria-label="Course level">
                        <option value="Beginner">Beginner</option>
                        <option value="Intermediate">Intermediate</option>
                        <option value="Advanced">Advanced</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="course-image" class="block text-gray-700 font-medium mb-2">Image URL</label>
                    <input type="url" id="course-image" class="w-full p-2 border border-gray-300 rounded-md" required aria-label="Course image URL">
                </div>
                <div class="mb-4">
                    <label for="course-rating" class="block text-gray-700 font-medium mb-2">Rating (0-5)</label>
                    <input type="number" id="course-rating" class="w-full p-2 border border-gray-300 rounded-md" min="0" max="5" step="0.1" aria-label="Course rating">
                </div>
                <div class="mb-4">
                    <label for="course-reviews" class="block text-gray-700 font-medium mb-2">Reviews</label>
                    <input type="number" id="course-reviews" class="w-full p-2 border border-gray-300 rounded-md" min="0" aria-label="Number of reviews">
                </div>
                <div class="mb-4">
                    <label for="course-lectures" class="block text-gray-700 font-medium mb-2">Lectures</label>
                    <input type="number" id="course-lectures" class="w-full p-2 border border-gray-300 rounded-md" min="0" aria-label="Number of lectures">
                </div>
                <div class="mb-4">
                    <label for="course-bestseller" class="flex items-center">
                        <input type="checkbox" id="course-bestseller" class="mr-2" aria-label="Mark as bestseller">
                        <span>Bestseller</span>
                    </label>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="course-modal-cancel" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400 transition" aria-label="Cancel adding course">Cancel</button>
                    <button type="submit" id="course-submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition" aria-label="Save course">Save Course</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div id="category-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-xl shadow-md max-w-md w-full">
            <h4 id="category-form-title" class="text-lg font-semibold text-gray-800 mb-4">Add New Category</h4>
            <form id="category-form">
                <input type="hidden" id="category-id">
                <div class="mb-4">
                    <label for="category-title" class="block text-gray-700 font-medium mb-2">Title</label>
                    <input type="text" id="category-title" class="w-full p-2 border border-gray-300 rounded-md" required aria-label="Category title">
                </div>
                <div class="mb-4">
                    <label for="category-description" class="block text-gray-700 font-medium mb-2">Description</label>
                    <textarea id="category-description" class="w-full p-2 border border-gray-300 rounded-md" required aria-label="Category description"></textarea>
                </div>
                <div class="mb-4">
                    <label for="category-group" class="block text-gray-700 font-medium mb-2">Group</label>
                    <select id="category-group" class="w-full p-2 border border-gray-300 rounded-md" required aria-label="Category group">
                        <option value="technology">Technology</option>
                        <option value="business">Business</option>
                        <option value="creative">Creative</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="category-icon" class="block text-gray-700 font-medium mb-2">Icon (Font Awesome class, e.g., fa-laptop-code)</label>
                    <input type="text" id="category-icon" class="w-full p-2 border border-gray-300 rounded-md" required aria-label="Category icon class">
                </div>
                <div class="mb-4">
                    <label for="category-popularity" class="block text-gray-700 font-medium mb-2">Popularity</label>
                    <input type="number" id="category-popularity" class="w-full p-2 border border-gray-300 rounded-md" min="0" aria-label="Category popularity">
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="category-modal-cancel" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400 transition" aria-label="Cancel adding category">Cancel</button>
                    <button type="submit" id="category-submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition" aria-label="Save category">Save Category</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button id="add-button" class="hidden fixed bottom-16 right-4 bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700 transition sm:bottom-4" aria-label="Add new item">
        <i class="fas fa-plus text-lg"></i>
    </button>

    <!-- Bottom Navigation (Mobile) -->
    <nav class="sm:hidden fixed bottom-0 left-0 right-0 bg-white shadow-t-md z-50">
        <div class="flex justify-around py-2">
            <button class="mobile-nav-button flex flex-col items-center text-gray-600 hover:text-blue-600" data-tab="dashboard">
                <i class="fas fa-gauge text-lg"></i>
                <span class="text-xs">Dashboard</span>
            </button>
            <button class="mobile-nav-button flex flex-col items-center text-gray-600 hover:text-blue-600" data-tab="courses">
                <i class="fas fa-book text-lg"></i>
                <span class="text-xs">Courses</span>
            </button>
            <button class="mobile-nav-button flex flex-col items-center text-gray-600 hover:text-blue-600" data-tab="categories">
                <i class="fas fa-folder text-lg"></i>
                <span class="text-xs">Categories</span>
            </button>
            <button class="mobile-nav-button flex flex-col items-center text-gray-600 hover:text-blue-600" data-tab="messages">
                <i class="fas fa-envelope text-lg"></i>
                <span class="text-xs">Messages</span>
            </button>
        </div>
    </nav>

    <script>
    const API_URL = 'https://learnhub-r94s.onrender.com/api';
    const ADMIN_PASSWORD = localStorage.getItem('adminPassword');

    // Check if logged in
    if (ADMIN_PASSWORD) {
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('dashboard-section').classList.remove('hidden');
        fetchData();
    }

    // Sidebar toggle for mobile
    document.getElementById('sidebar-toggle').addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('active');
    });

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', (e) => {
        const sidebar = document.getElementById('sidebar');
        const toggleButton = document.getElementById('sidebar-toggle');
        if (!sidebar.contains(e.target) && !toggleButton.contains(e.target) && sidebar.classList.contains('active')) {
            sidebar.classList.remove('active');
        }
    });

    // Login
    document.getElementById('login-button').addEventListener('click', async () => {
        const password = document.getElementById('password').value;
        try {
            const response = await fetch(`${API_URL}/admin/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            });
            if (response.ok) {
                localStorage.setItem('adminPassword', password);
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('dashboard-section').classList.remove('hidden');
                fetchData();
            } else {
                const error = await response.json();
                alert(error.error || 'Login failed');
            }
        } catch (err) {
            console.error('Error during login:', err);
            alert('Login failed');
        }
    });

    // Logout
    document.getElementById('logout-button').addEventListener('click', () => {
        localStorage.removeItem('adminPassword');
        document.getElementById('login-section').classList.remove('hidden');
        document.getElementById('dashboard-section').classList.add('hidden');
        document.getElementById('add-button').classList.add('hidden');
        document.getElementById('sidebar').classList.remove('active');
    });

    // Tab switching
    const navButtons = document.querySelectorAll('.sidebar-button, .mobile-nav-button');
    navButtons.forEach(button => {
        button.addEventListener('click', () => {
            navButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.classList.contains('sidebar-button')) {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('text-gray-600');
                } else {
                    btn.classList.remove('text-blue-600');
                    btn.classList.add('text-gray-600');
                }
            });
            button.classList.add('active');
            if (button.classList.contains('sidebar-button')) {
                button.classList.add('bg-blue-600', 'text-white');
                button.classList.remove('text-gray-600');
            } else {
                button.classList.add('text-blue-600');
                button.classList.remove('text-gray-600');
            }
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`${button.dataset.tab}-tab`).classList.add('active');
            // Show/hide add button
            const addButton = document.getElementById('add-button');
            if (button.dataset.tab === 'courses' || button.dataset.tab === 'categories') {
                addButton.classList.remove('hidden');
                addButton.dataset.modal = button.dataset.tab === 'courses' ? 'course-modal' : 'category-modal';
                addButton.setAttribute('aria-label', `Add new ${button.dataset.tab.slice(0, -1)}`);
            } else {
                addButton.classList.add('hidden');
            }
            // Close sidebar on mobile after selection
            if (window.innerWidth < 640) {
                document.getElementById('sidebar').classList.remove('active');
            }
        });
    });
    // Default to dashboard tab
    document.querySelector('.sidebar-button[data-tab="dashboard"]').classList.add('active', 'bg-blue-600', 'text-white');
    document.querySelector('.mobile-nav-button[data-tab="dashboard"]').classList.add('active', 'text-blue-600');
    document.getElementById('dashboard-tab').classList.add('active');

    // Add button to open modal
    document.getElementById('add-button').addEventListener('click', () => {
        const modalId = document.getElementById('add-button').dataset.modal;
        const modal = document.getElementById(modalId);
        modal.classList.add('active');
        modal.querySelector('input, select, textarea').focus();
    });

    // Modal cancel buttons
    document.getElementById('course-modal-cancel').addEventListener('click', () => {
        document.getElementById('course-modal').classList.remove('active');
        document.getElementById('course-form').reset();
        document.getElementById('course-id').value = '';
        document.getElementById('course-form-title').textContent = 'Add New Course';
        document.getElementById('course-submit').textContent = 'Save Course';
    });

    document.getElementById('category-modal-cancel').addEventListener('click', () => {
        document.getElementById('category-modal').classList.remove('active');
        document.getElementById('category-form').reset();
        document.getElementById('category-id').value = '';
        document.getElementById('category-form-title').textContent = 'Add New Category';
        document.getElementById('category-submit').textContent = 'Save Category';
    });

    // Click outside modal to close
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.remove('active');
                modal.querySelector('form').reset();
                const formId = modal.id.replace('-modal', '-form');
                document.getElementById(formId).querySelector('input[type="hidden"]').value = '';
                document.getElementById(formId.replace('-form', '-form-title')).textContent = `Add New ${formId.split('-')[0].replace(/^\w/, c => c.toUpperCase())}`;
                document.getElementById(formId.replace('-form', '-submit')).textContent = `Save ${formId.split('-')[0].replace(/^\w/, c => c.toUpperCase())}`;
            }
        });
    });

    // Fetch categories for course form dropdown
    async function fetchCategoriesForDropdown() {
        try {
            const response = await fetch(`${API_URL}/categories`);
            const categories = await response.json();
            const select = document.getElementById('course-category');
            select.innerHTML = categories.map(category => `
                <option value="${category._id}">${category.title}</option>
            `).join('');
            return categories;
        } catch (err) {
            console.error('Error fetching categories for dropdown:', err);
            return [];
        }
    }

    // Fetch and render courses
    async function fetchCourses() {
        try {
            const response = await fetch(`${API_URL}/courses`);
            const courses = await response.json();
            const courseTable = document.getElementById('course-table');
            courseTable.innerHTML = courses.map(course => `
                <tr>
                    <td class="p-4 text-gray-700">${course.title}</td>
                    <td class="p-4 text-gray-700">${course.category.title}</td>
                    <td class="p-4 text-gray-700">${course.level}</td>
                    <td class="p-4">
                        <button class="edit-course bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700" data-id="${course._id}" aria-label="Edit ${course.title}">Edit</button>
                        <button class="delete-course bg-red-600 text-white px-3 py-1 rounded-md hover:bg-red-700 ml-2" data-id="${course._id}" aria-label="Delete ${course.title}">Delete</button>
                    </td>
                </tr>
            `).join('');
            // Latest Course Update
            const latestCourseDiv = document.getElementById('latest-course-update');
            const latestCourseDashboard = document.getElementById('latest-course');
            if (courses.length > 0) {
                const latestCourse = courses.sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt))[0];
                const updateText = `
                    <p class="text-gray-700"><strong>Title:</strong> ${latestCourse.title}</p>
                    <p class="text-gray-700"><strong>Category:</strong> ${latestCourse.category.title}</p>
                    <p class="text-gray-700"><strong>Updated:</strong> ${new Date(latestCourse.updatedAt || latestCourse.createdAt).toLocaleString()}</p>
                `;
                latestCourseDiv.innerHTML = `<h4 class="text-lg font-semibold text-gray-800 mb-2">Latest Course Update</h4>${updateText}`;
                latestCourseDashboard.innerHTML = `<h4 class="text-lg font-semibold text-gray-800 mb-2">Latest Course</h4>${updateText}`;
            } else {
                latestCourseDiv.innerHTML = `<h4 class="text-lg font-semibold text-gray-800 mb-2">Latest Course Update</h4><p class="text-gray-700">No courses available.</p>`;
                latestCourseDashboard.innerHTML = `<h4 class="text-lg font-semibold text-gray-800 mb-2">Latest Course</h4><p class="text-gray-700">No courses available.</p>`;
            }
            // Add event listeners for edit and delete buttons
            document.querySelectorAll('.edit-course').forEach(button => {
                button.addEventListener('click', () => editCourse(button.dataset.id));
            });
            document.querySelectorAll('.delete-course').forEach(button => {
                button.addEventListener('click', () => deleteCourse(button.dataset.id));
            });
            return courses;
        } catch (err) {
            console.error('Error fetching courses:', err);
            document.getElementById('course-table').innerHTML = '<tr><td colspan="4" class="p-4 text-red-600 text-center">Failed to load courses.</td></tr>';
            document.getElementById('latest-course-update').innerHTML = '<h4 class="text-lg font-semibold text-gray-800 mb-2">Latest Course Update</h4><p class="text-red-600">Failed to load courses.</p>';
            document.getElementById('latest-course').innerHTML = `<h4 class="text-lg font-semibold text-gray-800 mb-2">Latest Course</h4><p class="text-red-600">Failed to load courses.</p>`;
            return [];
        }
    }

    // Fetch and render categories
    async function fetchCategories() {
        try {
            const response = await fetch(`${API_URL}/categories`);
            const categories = await response.json();
            const categoryTable = document.getElementById('category-table');
            categoryTable.innerHTML = categories.map(category => `
                <tr>
                    <td class="p-4 text-gray-700">${category.title}</td>
                    <td class="p-4 text-gray-700">${category.group}</td>
                    <td class="p-4 text-gray-700">${category.courseCount}</td>
                    <td class="p-4">
                        <button class="edit-category bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700" data-id="${category._id}" aria-label="Edit ${category.title}">Edit</button>
                        <button class="delete-category bg-red-600 text-white px-3 py-1 rounded-md hover:bg-red-700 ml-2" data-id="${category._id}" aria-label="Delete ${category.title}">Delete</button>
                    </td>
                </tr>
            `).join('');
            // Latest Category Update
            const latestCategoryDiv = document.getElementById('latest-category-update');
            const latestCategoryDashboard = document.getElementById('latest-category');
            if (categories.length > 0) {
                const latestCategory = categories.sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt))[0];
                const updateText = `
                    <p class="text-gray-700"><strong>Title:</strong> ${latestCategory.title}</p>
                    <p class="text-gray-700"><strong>Group:</strong> ${latestCategory.group}</p>
                    <p class="text-gray-700"><strong>Updated:</strong> ${new Date(latestCategory.updatedAt || latestCategory.createdAt).toLocaleString()}</p>
                `;
                latestCategoryDiv.innerHTML = `<h4 class="text-lg font-semibold text-gray-800 mb-2">Latest Category Update</h4>${updateText}`;
                latestCategoryDashboard.innerHTML = `<h4 class="text-lg font-semibold text-gray-800 mb-2">Latest Category</h4>${updateText}`;
            } else {
                latestCategoryDiv.innerHTML = `<h4 class="text-lg font-semibold text-gray-800 mb-2">Latest Category Update</h4><p class="text-gray-700">No categories available.</p>`;
                latestCategoryDashboard.innerHTML = `<h4 class="text-lg font-semibold text-gray-800 mb-2">Latest Category</h4><p class="text-gray-700">No categories available.</p>`;
            }
            // Add event listeners for edit and delete buttons
            document.querySelectorAll('.edit-category').forEach(button => {
                button.addEventListener('click', () => editCategory(button.dataset.id));
            });
            document.querySelectorAll('.delete-category').forEach(button => {
                button.addEventListener('click', () => deleteCategory(button.dataset.id));
            });
            return categories;
        } catch (err) {
            console.error('Error fetching categories:', err);
            document.getElementById('category-table').innerHTML = '<tr><td colspan="4" class="p-4 text-red-600 text-center">Failed to load categories.</td></tr>';
            document.getElementById('latest-category-update').innerHTML = '<h4 class="text-lg font-semibold text-gray-800 mb-2">Latest Category Update</h4><p class="text-red-600">Failed to load categories.</p>';
            document.getElementById('latest-category').innerHTML = '<h4 class="text-lg font-semibold text-gray-800 mb-2">Latest Category</h4><p class="text-red-600">Failed to load categories.</p>';
            return [];
        }
    }

    // Fetch and render messages
    async function fetchMessages() {
        try {
            const response = await fetch(`${API_URL}/messages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: ADMIN_PASSWORD })
            });
            const messages = await response.json();
            const messageTable = document.getElementById('message-table');
            messageTable.innerHTML = messages.map(message => `
                <tr>
                    <td class="p-4 text-gray-700">${message.name}</td>
                    <td class="p-4 text-gray-700">${message.email}</td>
                    <td class="p-4 text-gray-700">${message.subject}</td>
                    <td class="p-4 text-gray-700">${message.message}</td>
                    <td class="p-4 text-gray-700">${new Date(message.createdAt).toLocaleString()}</td>
                </tr>
            `).join('');
            // Latest Message Update
            const latestMessageDiv = document.getElementById('latest-message-update');
            const latestMessageDashboard = document.getElementById('latest-message');
            if (messages.length > 0) {
                const latestMessage = messages.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))[0];
                const updateText = `
                    <p class="text-gray-700"><strong>Name:</strong> ${latestMessage.name}</p>
                    <p class="text-gray-700"><strong>Subject:</strong> ${latestMessage.subject}</p>
                    <p class="text-gray-700"><strong>Received:</strong> ${new Date(latestMessage.createdAt).toLocaleString()}</p>
                `;
                latestMessageDiv.innerHTML = `<h4 class="text-lg font-semibold text-gray-800 mb-2">Latest Message</h4>${updateText}`;
                latestMessageDashboard.innerHTML = `<h4 class="text-lg font-semibold text-gray-800 mb-2">Latest Message</h4>${updateText}`;
            } else {
                latestMessageDiv.innerHTML = `<h4 class="text-lg font-semibold text-gray-800 mb-2">Latest Message</h4><p class="text-gray-700">No messages available.</p>`;
                latestMessageDashboard.innerHTML = `<h4 class="text-lg font-semibold text-gray-800 mb-2">Latest Message</h4><p class="text-gray-700">No messages available.</p>`;
            }
            return messages;
        } catch (err) {
            console.error('Error fetching messages:', err);
            document.getElementById('message-table').innerHTML = '<tr><td colspan="5" class="p-4 text-red-600 text-center">Failed to load messages.</td></tr>';
            document.getElementById('latest-message-update').innerHTML = '<h4 class="text-lg font-semibold text-gray-800 mb-2">Latest Message</h4><p class="text-red-600">Failed to load messages.</p>';
            document.getElementById('latest-message').innerHTML = '<h4 class="text-lg font-semibold text-gray-800 mb-2">Latest Message</h4><p class="text-red-600">Failed to load messages.</p>';
            return [];
        }
    }

    // Fetch analytics data
    async function fetchAnalytics() {
        try {
            const [courses, categories, messages, visitors] = await Promise.all([
                fetchCourses(),
                fetchCategories(),
                fetchMessages(),
                fetch(`${API_URL}/visitors`).then(res => res.json())
            ]);

            // Total Visitors
            document.getElementById('total-visitors').textContent = visitors.count || 0;

            // Courses by Category
            const techCourses = categories.filter(c => c.group === 'technology').reduce((sum, c) => sum + c.courseCount, 0);
            const businessCourses = categories.filter(c => c.group === 'business').reduce((sum, c) => sum + c.courseCount, 0);
            const creativeCourses = categories.filter(c => c.group === 'creative').reduce((sum, c) => sum + c.courseCount, 0);
            document.getElementById('tech-courses').textContent = techCourses;
            document.getElementById('business-courses').textContent = businessCourses;
            document.getElementById('creative-courses').textContent = creativeCourses;

            // Top-Rated Courses
            const topCourses = courses
                .filter(course => course.reviews >= 10)
                .sort((a, b) => b.rating - a.rating)
                .slice(0, 3);
            const topRatedDiv = document.getElementById('top-rated-courses');
            if (topCourses.length > 0) {
                topRatedDiv.innerHTML = topCourses.map(course => `
                    <p class="text-gray-700">${course.title} (${course.rating}/5, ${course.reviews} reviews)</p>
                `).join('');
            } else {
                topRatedDiv.innerHTML = '<p class="text-gray-700">No top-rated courses available.</p>';
            }

            // Messages per Day (Last 7 Days)
            const today = new Date('2025-07-11T00:00:00+01:00');
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 6);
            const messageCounts = Array(7).fill(0);
            const labels = Array(7).fill('').map((_, i) => {
                const date = new Date(sevenDaysAgo);
                date.setDate(sevenDaysAgo.getDate() + i);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            messages.forEach(msg => {
                const msgDate = new Date(msg.createdAt);
                if (msgDate >= sevenDaysAgo && msgDate <= today) {
                    const dayIndex = Math.floor((msgDate - sevenDaysAgo) / (1000 * 60 * 60 * 24));
                    if (dayIndex >= 0 && dayIndex < 7) {
                        messageCounts[dayIndex]++;
                    }
                }
            });

            // Render Chart
            const ctx = document.getElementById('messages-chart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Messages',
                        data: messageCounts,
                        backgroundColor: '#4A90E2',
                        borderColor: '#4A90E2',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Message Count' }
                        },
                        x: {
                            title: { display: true, text: 'Date' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Total Courses and Categories
            document.getElementById('total-courses').textContent = courses.length;
            document.getElementById('total-categories').textContent = categories.length;

            // New Messages Today
            const tomorrow = new Date('2025-07-12T00:00:00+01:00');
            const newMessages = messages.filter(msg => {
                const msgDate = new Date(msg.createdAt);
                return msgDate >= today && msgDate < tomorrow;
            });
            document.getElementById('new-messages').textContent = newMessages.length;
        } catch (err) {
            console.error('Error fetching analytics:', err);
            document.getElementById('total-visitors').textContent = 'Error';
            document.getElementById('total-courses').textContent = 'Error';
            document.getElementById('total-categories').textContent = 'Error';
            document.getElementById('new-messages').textContent = 'Error';
            document.getElementById('courses-by-category').innerHTML = '<p class="text-red-600">Failed to load analytics.</p>';
            document.getElementById('top-rated-courses').innerHTML = '<p class="text-red-600">Failed to load top-rated courses.</p>';
        }
    }

    // Edit course
    async function editCourse(id) {
        try {
            const response = await fetch(`${API_URL}/courses/${id}`);
            const course = await response.json();
            document.getElementById('course-id').value = course._id;
            document.getElementById('course-title').value = course.title;
            document.getElementById('course-description').value = course.description;
            document.getElementById('course-category').value = course.category._id;
            document.getElementById('course-level').value = course.level;
            document.getElementById('course-image').value = course.image;
            document.getElementById('course-rating').value = course.rating;
            document.getElementById('course-reviews').value = course.reviews;
            document.getElementById('course-lectures').value = course.lectures;
            document.getElementById('course-bestseller').checked = course.isBestseller;
            document.getElementById('course-form-title').textContent = 'Edit Course';
            document.getElementById('course-submit').textContent = 'Update Course';
            document.getElementById('course-modal').classList.add('active');
            document.getElementById('course-title').focus();
            // Switch to Courses tab
            navButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.classList.contains('sidebar-button')) {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('text-gray-600');
                } else {
                    btn.classList.remove('text-blue-600');
                    btn.classList.add('text-gray-600');
                }
            });
            const courseButton = document.querySelector('.sidebar-button[data-tab="courses"]');
            const mobileCourseButton = document.querySelector('.mobile-nav-button[data-tab="courses"]');
            courseButton.classList.add('active', 'bg-blue-600', 'text-white');
            mobileCourseButton.classList.add('active', 'text-blue-600');
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById('courses-tab').classList.add('active');
            document.getElementById('add-button').classList.remove('hidden');
            document.getElementById('add-button').dataset.modal = 'course-modal';
            document.getElementById('add-button').setAttribute('aria-label', 'Add new course');
            if (window.innerWidth < 640) {
                document.getElementById('sidebar').classList.remove('active');
            }
        } catch (err) {
            console.error('Error fetching course for edit:', err);
            alert('Failed to load course data.');
        }
    }

    // Delete course
    async function deleteCourse(id) {
        if (!confirm('Are you sure you want to delete this course?')) return;
        try {
            const response = await fetch(`${API_URL}/courses/${id}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: ADMIN_PASSWORD })
            });
            if (response.ok) {
                alert('Course deleted successfully');
                fetchCourses();
                fetchAnalytics();
            } else {
                throw new Error('Failed to delete course');
            }
        } catch (err) {
            console.error('Error deleting course:', err);
            alert('Failed to delete course.');
        }
    }

    // Edit category
    async function editCategory(id) {
        try {
            const response = await fetch(`${API_URL}/categories/${id}`);
            const category = await response.json();
            document.getElementById('category-id').value = category._id;
            document.getElementById('category-title').value = category.title;
            document.getElementById('category-description').value = category.description;
            document.getElementById('category-group').value = category.group;
            document.getElementById('category-icon').value = category.icon;
            document.getElementById('category-popularity').value = category.popularity;
            document.getElementById('category-form-title').textContent = 'Edit Category';
            document.getElementById('category-submit').textContent = 'Update Category';
            document.getElementById('category-modal').classList.add('active');
            document.getElementById('category-title').focus();
            // Switch to Categories tab
            navButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.classList.contains('sidebar-button')) {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('text-gray-600');
                } else {
                    btn.classList.remove('text-blue-600');
                    btn.classList.add('text-gray-600');
                }
            });
            const categoryButton = document.querySelector('.sidebar-button[data-tab="categories"]');
            const mobileCategoryButton = document.querySelector('.mobile-nav-button[data-tab="categories"]');
            categoryButton.classList.add('active', 'bg-blue-600', 'text-white');
            mobileCategoryButton.classList.add('active', 'text-blue-600');
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById('categories-tab').classList.add('active');
            document.getElementById('add-button').classList.remove('hidden');
            document.getElementById('add-button').dataset.modal = 'category-modal';
            document.getElementById('add-button').setAttribute('aria-label', 'Add new category');
            if (window.innerWidth < 640) {
                document.getElementById('sidebar').classList.remove('active');
            }
        } catch (err) {
            console.error('Error fetching category for edit:', err);
            alert('Failed to load category data.');
        }
    }

    // Delete category
    async function deleteCategory(id) {
        if (!confirm('Are you sure you want to delete this category?')) return;
        try {
            const response = await fetch(`${API_URL}/categories/${id}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: ADMIN_PASSWORD })
            });
            if (response.ok) {
                alert('Category deleted successfully');
                fetchCategories();
                fetchCategoriesForDropdown();
                fetchAnalytics();
            } else {
                const error = await response.json();
                throw new Error(error.error || 'Failed to delete category');
            }
        } catch (err) {
            console.error('Error deleting category:', err);
            alert(err.message);
        }
    }

    // Course form submission
    document.getElementById('course-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('course-id').value;
        const data = {
            password: ADMIN_PASSWORD,
            title: document.getElementById('course-title').value,
            description: document.getElementById('course-description').value,
            category: document.getElementById('course-category').value,
            level: document.getElementById('course-level').value,
            image: document.getElementById('course-image').value,
            rating: document.getElementById('course-rating').value,
            reviews: document.getElementById('course-reviews').value,
            lectures: document.getElementById('course-lectures').value,
            isBestseller: document.getElementById('course-bestseller').checked
        };
        try {
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/courses/${id}` : `${API_URL}/courses`;
            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (response.ok) {
                alert(id ? 'Course updated successfully' : 'Course created successfully');
                document.getElementById('course-form').reset();
                document.getElementById('course-id').value = '';
                document.getElementById('course-form-title').textContent = 'Add New Course';
                document.getElementById('course-submit').textContent = 'Save Course';
                document.getElementById('course-modal').classList.remove('active');
                fetchCourses();
                fetchAnalytics();
            } else {
                throw new Error('Failed to save course');
            }
        } catch (err) {
            console.error('Error saving course:', err);
            alert('Failed to save course.');
        }
    });

    // Category form submission
    document.getElementById('category-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('category-id').value;
        const data = {
            password: ADMIN_PASSWORD,
            title: document.getElementById('category-title').value,
            description: document.getElementById('category-description').value,
            group: document.getElementById('category-group').value,
            icon: document.getElementById('category-icon').value,
            popularity: document.getElementById('category-popularity').value
        };
        try {
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/categories/${id}` : `${API_URL}/categories`;
            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (response.ok) {
                alert(id ? 'Category updated successfully' : 'Category created successfully');
                document.getElementById('category-form').reset();
                document.getElementById('category-id').value = '';
                document.getElementById('category-form-title').textContent = 'Add New Category';
                document.getElementById('category-submit').textContent = 'Save Category';
                document.getElementById('category-modal').classList.remove('active');
                fetchCategories();
                fetchCategoriesForDropdown();
                fetchAnalytics();
            } else {
                throw new Error('Failed to save category');
            }
        } catch (err) {
            console.error('Error saving category:', err);
            alert('Failed to save category.');
        }
    });

    // Fetch initial data
    async function fetchData() {
        await fetchCategoriesForDropdown();
        await fetchAnalytics();
        await fetchCourses();
        await fetchCategories();
        await fetchMessages();
    }
</script>
</body>
</html>
